"use strict";(()=>{var e={};e.id=265,e.ids=[265],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},665:(e,t,n)=>{n.r(t),n.d(t,{originalPathname:()=>b,patchFetch:()=>x,requestAsyncStorage:()=>h,routeModule:()=>_,serverHooks:()=>v,staticGenerationAsyncStorage:()=>w});var a={};n.r(a),n.d(a,{POST:()=>g});var r=n(9303),s=n(8716),o=n(670);async function i(e){let t=process.env.HF_ACCESS_TOKEN;if(!t)return null;let n=new AbortController,a=setTimeout(()=>n.abort(),15e3),r=await fetch("https://api-inference.huggingface.co/models/mistralai/Mistral-7B-Instruct-v0.2",{method:"POST",headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"},body:JSON.stringify({inputs:e,parameters:{max_new_tokens:512,temperature:.7,top_p:.9}}),signal:n.signal});if(clearTimeout(a),!r.ok)return null;let s=await r.json();return Array.isArray(s)&&s[0]?.generated_text?String(s[0].generated_text):"string"==typeof s?s:JSON.stringify(s)}var u=n(748);async function c(e){let{supabase:t,user:n}=await (0,u.n)(e);if(!n)throw Error("N\xe3o autenticado");return{supabase:t,user:n}}async function l(e){let{supabase:t}=await c(e),{data:n}=await t.from("customers").select("id"),{data:a}=await t.from("appointments").select("id, status, appointment_date, price"),r=new Date().toISOString().slice(0,7),s=(a||[]).filter(e=>"completed"===e.status&&String(e.appointment_date||"").startsWith(r)).reduce((e,t)=>e+Number(t.price||0),0),o=(a||[]).filter(e=>["scheduled","confirmed"].includes(e.status)).length;return{totalCustomers:(n||[]).length,totalAppointments:(a||[]).length,monthlyRevenue:s,pendingAppointments:o}}async function p(e){let{supabase:t}=await c(e),n=new Date().toISOString().slice(0,10),{data:a,error:r}=await t.from("appointments").select("id, appointment_date, appointment_time, status, customers(name), services(name)").eq("appointment_date",n);if(r)throw r;return(a||[]).map(e=>({id:e.id,date:e.appointment_date,time:e.appointment_time,status:e.status,customer:e.customers?.name||"",service:e.services?.name||""}))}async function d(e){let{supabase:t}=await c(e),n=new Date().toISOString().slice(0,10),{data:a,error:r}=await t.from("invoices").select("id, invoice_number, client_id, due_date, status, total, customers(name, email)").lt("due_date",n).neq("status","paid");if(r)throw r;return(a||[]).map(e=>({id:e.id,invoice_number:e.invoice_number,client_id:e.client_id,due_date:e.due_date,total:e.total,client_name:e.customers?.name||"",client_email:e.customers?.email||""}))}var m=n(3895),f=n(7214);async function g(e){let t=Date.now(),n={requestId:e.headers.get("x-request-id")||void 0,path:e.nextUrl.pathname,method:e.method};try{m.k.info("api_request_start",n);let a=e.headers.get("x-forwarded-for")?.split(",")[0]||null;if(!(0,f.c)(a,"chatbot",60,6e4))return m.k.warn("rate_limited",{...n}),Response.json({reply:"Muitas solicita\xe7\xf5es. Tente novamente mais tarde."},{status:429});let r=await e.json(),s=r?.messages||[],o=r?.context||{},{user:c}=await (0,u.n)(e),g=s?.find(e=>"user"===e.role)?.content||"",_=String(g).toLowerCase();if(_.includes("resumo financeiro")||_.includes("kpi")){let a=await l(e),r=`Clientes: ${a.totalCustomers}. Agendamentos: ${a.totalAppointments}. Receita mensal: R$ ${a.monthlyRevenue.toLocaleString("pt-BR")}. Pendentes: ${a.pendingAppointments}.`,s=Response.json({reply:r});return m.k.info("api_request_end",{...n,status:200,duration_ms:Date.now()-t}),s}if(_.includes("pend\xeancias")||_.includes("agenda")){let a=(await p(e)).map(e=>`${e.time||""} ${e.customer} - ${e.service} (${e.status})`).join("\n")||"Sem compromissos para hoje.",r=Response.json({reply:a});return m.k.info("api_request_end",{...n,status:200,duration_ms:Date.now()-t}),r}if(_.includes("faturas em atraso")||_.includes("lembrete de pagamento")){let a=(await d(e)).map(e=>`#${e.invoice_number} ${e.client_name} venceu em ${new Date(e.due_date).toLocaleDateString("pt-BR")} (R$ ${Number(e.total||0).toLocaleString("pt-BR")})`).join("\n")||"Nenhuma fatura em atraso.",r=Response.json({reply:a});return m.k.info("api_request_end",{...n,status:200,duration_ms:Date.now()-t}),r}let h=function(e,t,n){let a=e?.find(e=>"user"===e.role)?.content||"",r=[],s=String(t?.page||"dashboard");return r.push(`P\xe1gina: ${s}`),n&&r.push(`Usu\xe1rio: ${n?.email||n?.id||""}`),`Voc\xea \xe9 o assistente do CRM Casa Limpa. Responda de forma objetiva e pr\xe1tica. Ajude com finan\xe7as, agenda, clientes e faturas. Quando conveniente, sugira passos acion\xe1veis. N\xe3o invente dados internos; ofere\xe7a a\xe7\xf5es para consultar ou criar informa\xe7\xf5es.
Contexto:
${r.join("\n")}
Pergunta:
${a}`}(s,o,c),w=await i(h);if(w)return m.k.info("chatbot_stream_start",n),new Response(function(e){let t=new TextEncoder,n=e.match(/.{1,80}/g)||[e];return new ReadableStream({start(e){let a=0,r=15,s=()=>{if(a>=n.length){e.close();return}e.enqueue(t.encode(n[a])),a+=1,r<60&&(r+=1),setTimeout(s,r)};s()}})}(w),{headers:{"Content-Type":"text/plain"}});let v=(s?.find(e=>"user"===e.role)?.content,{reply:"Posso consultar pend\xeancias, gerar resumo financeiro, criar clientes, agendar servi\xe7os e enviar lembretes de pagamento. Diga o que deseja e confirmarei antes de executar."}),b=Response.json(v);return m.k.info("api_request_end",{...n,status:200,duration_ms:Date.now()-t}),b}catch(e){return m.k.error("chatbot_error",{...n,err:e?.message||String(e)}),Response.json({reply:"N\xe3o foi poss\xedvel responder agora. Tente novamente.",error:!0},{status:200})}}let _=new r.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/chatbot/assistant/route",pathname:"/api/chatbot/assistant",filename:"route",bundlePath:"app/api/chatbot/assistant/route"},resolvedPagePath:"C:\\Users\\Enzo Marcelo\\Desktop\\testes SOLO TRAE\\crm casa limpa\\src\\app\\api\\chatbot\\assistant\\route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:h,staticGenerationAsyncStorage:w,serverHooks:v}=_,b="/api/chatbot/assistant/route";function x(){return(0,o.patchFetch)({serverHooks:v,staticGenerationAsyncStorage:w})}},9303:(e,t,n)=>{e.exports=n(517)},3895:(e,t,n)=>{n.d(t,{k:()=>u});let a={debug:10,info:20,warn:30,error:40},r=process.env.SERVICE_NAME||"crm-casa-limpa",s=process.env.LOG_LEVEL||"info",o="pretty"===process.env.LOG_FORMAT;function i(e,t,n){if(a[e]<a[s])return;let i={ts:new Date().toISOString(),level:e,env:"production",service:r,msg:t,...n||{}};if(o){let t=`[${i.ts}] ${e.toUpperCase()} ${i.msg} ${JSON.stringify(n||{})}`;"error"===e?console.error(t):"warn"===e?console.warn(t):console.log(t)}else{let t=JSON.stringify(i);"error"===e?console.error(t):"warn"===e?console.warn(t):console.log(t)}}let u={debug:(e,t)=>i("debug",e,t),info:(e,t)=>i("info",e,t),warn:(e,t)=>i("warn",e,t),error:(e,t)=>i("error",e,t)}},7214:(e,t,n)=>{n.d(t,{c:()=>r});let a=globalThis;function r(e,t,n,r){let s=`${e||"unknown"}:${t}`,o=Date.now(),i=a.__rl.get(s);return!i||i.resetAt<o?(a.__rl.set(s,{count:1,resetAt:o+r}),!0):i.count<n&&(i.count+=1,!0)}a.__rl=a.__rl||new Map},748:(e,t,n)=>{n.d(t,{n:()=>r});var a=n(2305);async function r(e){let t=(0,a.createServerClient)("https://hyygforlvwbbdzpctnid.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh5eWdmb3JsdndiYmR6cGN0bmlkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMyNjY1NjksImV4cCI6MjA3ODg0MjU2OX0.1ih4fZRYRzg1oqZxAYonDPi5wO2-DHvb7anjcSPWeqs",{cookies:{getAll:()=>e.cookies.getAll(),setAll(t){t.forEach(({name:t,value:n})=>e.cookies.set(t,n))}}}),{data:{user:n}}=await t.auth.getUser();return{supabase:t,user:n}}}};var t=require("../../../../webpack-runtime.js");t.C(e);var n=e=>t(t.s=e),a=t.X(0,[8948,2305],()=>n(665));module.exports=a})();